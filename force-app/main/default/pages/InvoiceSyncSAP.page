<apex:page controller="InvoiceToSAPController" title="开票同步"  docType="html-5.0"> 
   <c:importvisualstrap theme="default" /> 
    <apex:form >
       <apex:selectList id="chooseColor" value="{!PickListVal}" size="1"> 
          <apex:selectOption itemValue="All" itemLabel="All"/> 
          <apex:selectOption itemValue="CC01" itemLabel="CC01"/> 
          <apex:selectOption itemValue="CC02" itemLabel="CC02"/> 
          <apex:selectOption itemValue="CC03" itemLabel="CC03"/> 
          <apex:selectOption itemValue="CC08" itemLabel="CC08"/>
          <apex:selectOption itemValue="CC09" itemLabel="CC09"/>
          <apex:selectOption itemValue="CC14" itemLabel="CC14"/>
          <apex:selectOption itemValue="CC23" itemLabel="CC23"/>
          <apex:selectOption itemValue="U003" itemLabel="U003"/>
       </apex:selectList>
       <apex:commandButton value="提交" action="{!Refresh}"/>
    </apex:form>
   <c:visualstrapblock id="strap"> 
       <center>
         <c:pageheader title="Salesforce Sync SAP Tool" icon="calendar" subtitle="开票 {!$User.FirstName} {!$User.LastName}" style="margin:5px 0 20px"/>
       </center> 
   </c:visualstrapblock> 
<!--引用Salesforce的JS-->
  <script type="text/javascript">
    var __sfdcSessionId = '{!GETSESSIONID()}';
  </script>
  <script src="/soap/ajax/37.0/connection.js" type="text/javascript"></script>
   <script>
     function selectAll(){
        var tempVar = document.getElementsByClassName("ChioceALL");
        for(var i = 0;i < tempVar.length; i++){
           document.getElementsByClassName("ChioceALL")[i].checked = true;
        }
        return false;
     }
     
     function getChildRecord(RecordId){
       var DrawStr1 = "";
       var records1 = sforce.connection.query("Select Id, Name, contractNumber__c, ALL_SAP__c, ALLBHS_SAP__c, ALLHS_SAP__c, contractAmount__c, invoiceNumber__c, invoiceType__c, invoiceCode__c, invoice__r.isIncludingTax__c from invoiceItem__c where invoice__c ='" + RecordId + "'").getArray('records');
       for (var i=0; i< records1.length; i++) { 
           DrawStr1 = DrawStr1 +  "<tr><td>"+ Number(i+1) +"</td><td>" 
             + records1[i].Name + "</td><td>"
             + records1[i].contractNumber__c+ "</td><td>"
             + records1[i].ALL_SAP__c + "</td><td>"
             + records1[i].ALLBHS_SAP__c + "</td><td>"
             + records1[i].ALLHS_SAP__c + "</td><td>"
             + records1[i].contractAmount__c + "</td><td>"
             + records1[i].invoiceNumber__c + "</td><td>"
             + records1[i].invoiceType__c + "</td><td>"
             + records1[i].invoiceCode__c + "</td><td>"
             + records1[i].invoice__r.isIncludingTax__c + "</td></tr>";
       }
       var tempVar1 = document.getElementsByClassName("tbodySAP1")[0];
       
       var DrawStr2 = "";
       var records2 = sforce.connection.query("Select Id, Name, specificationsModel__c, quantity__c, unit__c, amount__c, price__c, CreatedDate from goodsName__c where invoice__c ='" + RecordId + "'").getArray('records');
       for (var i=0; i< records2.length; i++) { 
           DrawStr2 = DrawStr2 +  "<tr><td>"+ Number(i+1) +"</td><td>" 
             + records2[i].Name + "</td><td>"
             + records2[i].specificationsModel__c+ "</td><td>"
             + records2[i].quantity__c + "</td><td>"
             + records2[i].unit__c + "</td><td>"
             + records2[i].amount__c + "</td><td>"
             + records2[i].price__c + "</td><td>"
             + records2[i].CreatedDate + "</td></tr>";
       }
       var tempVar2 = document.getElementsByClassName("tbodySAP2")[0];
       
       
       tempVar1.innerHTML = DrawStr1;
       tempVar2.innerHTML = DrawStr2;
       $('#newCase').modal('show');
     
     }

   </script>
   
   <apex:includeScript value="{!URLFOR($Resource.jquery,'jquery.min.js')}"/>
   <apex:includeScript value="{!URLFOR($Resource.bootstrap,'bootstrap.min.js')}"/>

   <apex:form >
     <c:visualstrapblock > 
  
       <c:modal id="newCase">
         <span style="font-size:14px;font-weight:bold;color:#009999">开票项</span>
         <apex:outputPanel layout="block" id="newCasePanel" title="开票项">
           <table class="table" style="width:100%">
             <thead>
               <tr>
               <th>#</th>
               <th>编号</th>
               <th>合同号</th>
               <th>价税合计(总金额)</th>
               <th>不含税金额</th>
               <th>税额</th>
               <th>合同金额</th>
               <th>发票号</th>
               <th>发票类型</th>
               <th>发票版本号</th>
               <th>是否含税</th>
               </tr>
             </thead>
            <tbody class="tbodySAP1" styleClass ="tbodySAP1" ></tbody>
          </table>
          
         <span style="font-size:14px;font-weight:bold;color:#993300">货物或应税劳务名称</span>
           <table class="table" style="width:100%">
             <thead>
               <tr>
               <th>#</th>
               <th>货物或应税劳务名称</th>
               <th>规格型号</th>
               <th>数量</th>
               <th>单位</th>
               <th>金额(元)</th>
               <th>单价</th>     
               <th>创建日期</th>
               </tr>
             </thead>
            <tbody class="tbodySAP2" styleClass ="tbodySAP2" ></tbody>
          </table>        
        
        
          <apex:outputPanel layout="block" styleClass="modal-footer">

          </apex:outputPanel>
        
          <apex:outputPanel >
              <script>$('#newCase').modal('hide');</script>
          </apex:outputPanel>
        </apex:outputPanel>
      </c:modal>  
    
    </c:visualstrapblock>
  
    <apex:pageBlock id="pgTable">
        <apex:commandButton value="全选" action="{!SaveS}" onclick="return selectAll();"/>      
      <apex:pageBlockButtons location="top">
        <apex:commandButton value="同步给SAP" action="{!SaveS}" status="SAPSts"/>
        <apex:commandButton value="刷新" action="{!Refresh}"/>
        <apex:actionStatus id="SAPSts" startText="同步进行中,请等待..."/>
      </apex:pageBlockButtons>
     
      <apex:outputlabel >&nbsp;&nbsp;&nbsp;系统只显示未同步到SAP的开票记录,请在点击同步后刷新该页面</apex:outputlabel><br/>
      <apex:pageBlockTable value="{!ISList}" var="c" id="pgBlock" styleClass="invoiceSAP2">
        <apex:column headerValue="选择">
          <apex:inputcheckbox value="{!c.flag}" styleClass="ChioceALL"></apex:inputcheckbox>
        </apex:column> 
        <apex:column headerValue="操作" >
           <a class="btn btn-info btn-md" onclick="getChildRecord('{!c.RecordId}');">查看详细</a>
        </apex:column> 
        <apex:column headerValue="开票编号" >
           <apex:outputLink value="/{!c.RecordId}">{!c.RecordName}</apex:outputLink>          
        </apex:column> 
        <apex:column headerValue="申请人" >
           <apex:outputLink value="/{!c.ApplyBy}">{!c.ApplyByName}</apex:outputLink>          
        </apex:column> 
        <apex:column headerValue="申请部门" >
           <apex:outputLabel >{!c.ApplyByDept}</apex:outputLabel>             
        </apex:column> 
        <apex:column headerValue="开票总金额" >
           <apex:outputLabel >{!c.InvoiceAmountSum}</apex:outputLabel>             
        </apex:column>
        <apex:column headerValue="客户名称">
           <apex:outputLink value="/{!c.AccountId}">{!c.AccountName}</apex:outputLink>          
        </apex:column>
        <apex:column headerValue="开票单位">
           <apex:outputLabel value="{!c.invoiceCompanyCode}" />          
        </apex:column>
       
        <apex:column headerValue="税率">
           <apex:outputLabel >{!c.TaxRate}</apex:outputLabel>          
        </apex:column> 
        <apex:column headerValue="同步SAP状态">
           <apex:outputLabel >{!c.PushSAPStatus}</apex:outputLabel>          
        </apex:column> 
                    
      </apex:pageBlockTable>
      <apex:pageBlockSection >
        <apex:commandButton value="上一页" action="{!Previous}" rerender="pgTable,pgBlock" status="status" disabled="{!PreviousStatus}" style="float:left"/>
        <apex:commandButton value="下一页" action="{!Next}" reRender="pgTable,pgBlock" status="status" disabled="{!NextStatus}" style="float:right"/>
        <apex:actionStatus id="status" startText="Please Wait..."/>
      </apex:pageBlockSection>
    </apex:pageBlock>
  </apex:form>
   
</apex:page>